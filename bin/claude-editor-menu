#!/usr/bin/env bash
# Helper script to show FZF menu from within tmux sessions
# Called by:
# 1. User typing 'menu' in terminal (alias set in Open Terminal option)
# 2. Tmux keybinding (Ctrl-` from lib/nested-tmux.conf)
# 3. User typing 'claude-editor-menu' from any terminal

# Get the file path from environment variable set by "Open Terminal"
# If not set, we're in general context (not inside Claude session)
FILE="${PROMPT:-}"

# Get the directory where this script lives (to find lib/menu-core.sh)
# Strategy: Find g-menu (which is symlinked as claude-editor-hook), follow it to the repo
GMENU_BIN=$(which claude-editor-hook 2>/dev/null)
if [ -z "$GMENU_BIN" ]; then
    echo "Error: Cannot find claude-editor-hook in PATH"
    exit 1
fi

# Follow symlinks to find actual installation
while [ -L "$GMENU_BIN" ]; do
    GMENU_DIR="$(cd -P "$(dirname "$GMENU_BIN")" && pwd)"
    GMENU_BIN="$(readlink "$GMENU_BIN")"
    [[ $GMENU_BIN != /* ]] && GMENU_BIN="$GMENU_DIR/$GMENU_BIN"
done
GMENU_DIR="$(cd -P "$(dirname "$GMENU_BIN")" && pwd)"

# menu-core.sh is in the lib/ directory next to bin/
MENU_CORE="$GMENU_DIR/../lib/menu-core.sh"
if [ ! -f "$MENU_CORE" ]; then
    echo "Error: Cannot find lib/menu-core.sh at $MENU_CORE"
    exit 1
fi
source "$MENU_CORE"

# If we're in tmux, open menu in new window
# Otherwise, just show menu directly
if [ -n "$TMUX" ]; then
    # Open menu in new tmux window within existing session
    # When the window closes, it automatically returns to the calling window
    # Export CLAUDE_MENU_DIR so menu-core.sh can find helper scripts (point to lib/ dir)
    tmux new-window "export CLAUDE_MENU_DIR='$GMENU_DIR/../lib' && source '$MENU_CORE' && show_menu '$FILE'"
else
    # Not in tmux, just show menu directly
    # Export CLAUDE_MENU_DIR for consistency (point to lib/ dir)
    export CLAUDE_MENU_DIR="$GMENU_DIR/../lib"
    show_menu "$FILE"
fi
