#!/usr/bin/env bash
#
# Claude Editor Hook - Main Wrapper
#
# This script intercepts $EDITOR calls from Claude Code's Ctrl-G hotkey
# and dispatches to appropriate launchers based on context files written by Claude.
#
# Usage: Set export EDITOR="claude-editor-hook" in your shell config

set -euo pipefail

# Find the directory where this script lives
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="$SCRIPT_DIR/../lib"

# Context file location (where Claude writes configuration)
CONTEXT_FILE="${CLAUDE_EDITOR_CONTEXT:-$HOME/.claude/editor-context.yaml}"

# Default fallback editor
DEFAULT_EDITOR="${FALLBACK_EDITOR:-emacs -nw}"

# Load utilities
source "$LIB_DIR/utils.sh"

# Main function
main() {
    local temp_file="${1:-}"

    # Check if context file exists
    if [[ ! -f "$CONTEXT_FILE" ]]; then
        log_debug "No context file found at $CONTEXT_FILE, using default editor"
        exec $DEFAULT_EDITOR "$temp_file"
        return
    fi

    log_debug "Found context file: $CONTEXT_FILE"

    # Source the config reader to parse context file
    source "$LIB_DIR/config-reader.sh"

    # Parse the context file
    parse_context "$CONTEXT_FILE"

    # Get the mode (defaults to 'emacs' if not specified)
    local mode="${EDITOR_HOOK_MODE:-emacs}"

    log_debug "Mode: $mode"

    # Dispatch to appropriate launcher
    case "$mode" in
        emacs)
            exec "$LIB_DIR/launcher-emacs.sh" "$CONTEXT_FILE"
            ;;
        batcat|bat)
            exec "$LIB_DIR/launcher-batcat.sh" "$CONTEXT_FILE"
            ;;
        menu)
            exec "$LIB_DIR/launcher-menu.sh" "$CONTEXT_FILE"
            ;;
        tmux)
            exec "$LIB_DIR/launcher-tmux.sh" "$CONTEXT_FILE"
            ;;
        custom)
            local custom_launcher="${EDITOR_HOOK_CUSTOM_LAUNCHER:-}"
            if [[ -n "$custom_launcher" && -x "$custom_launcher" ]]; then
                exec "$custom_launcher" "$CONTEXT_FILE"
            else
                log_error "Custom launcher not found or not executable: $custom_launcher"
                exec $DEFAULT_EDITOR "$temp_file"
            fi
            ;;
        *)
            log_error "Unknown mode: $mode, falling back to default editor"
            exec $DEFAULT_EDITOR "$temp_file"
            ;;
    esac
}

# Run main function
main "$@"
