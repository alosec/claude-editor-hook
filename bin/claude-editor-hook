#!/usr/bin/env bash

# Debug logging
LOG="/tmp/claude-editor-hook.log"
echo "=== $(date) ===" >> "$LOG"
echo "Args: $@" >> "$LOG"
echo "TMUX: $TMUX" >> "$LOG"

# Store the file path
FILE="$1"

# Get the directory where this script lives (for finding lib/nested-tmux.conf)
# Follow symlinks to get the actual script location
SCRIPT_SOURCE="${BASH_SOURCE[0]:-$0}"
while [ -L "$SCRIPT_SOURCE" ]; do
    SCRIPT_DIR="$(cd -P "$(dirname "$SCRIPT_SOURCE")" && pwd)"
    SCRIPT_SOURCE="$(readlink "$SCRIPT_SOURCE")"
    [[ $SCRIPT_SOURCE != /* ]] && SCRIPT_SOURCE="$SCRIPT_DIR/$SCRIPT_SOURCE"
done
SCRIPT_DIR="$(cd -P "$(dirname "$SCRIPT_SOURCE")" && pwd)"
NESTED_CONF="$SCRIPT_DIR/../lib/nested-tmux.conf"

# Session name - always use "Claude" for simplicity
SESSION_NAME="Claude"

# Menu command (reused for both new session and respawn)
# Must source menu-core.sh inside the bash -c context
MENU_CMD="source '$SCRIPT_DIR/../lib/menu-core.sh' && show_menu '$FILE'"

# Unset TMUX to allow nested sessions
unset TMUX

# Check if session exists
if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
    echo "Session '$SESSION_NAME' exists, reattaching" >> "$LOG"

    # Update PROMPT environment variable for the session
    tmux set-environment -t "$SESSION_NAME" PROMPT "$FILE"

    # Respawn window 0 with fresh menu (preserves other windows including terminals)
    # Use select-window first to ensure window 0 exists, create if not
    tmux select-window -t "$SESSION_NAME:0" 2>/dev/null || tmux new-window -t "$SESSION_NAME:0"
    tmux respawn-window -t "$SESSION_NAME:0" -k bash -c "$MENU_CMD"

    # Attach to the session
    exec tmux -f "$NESTED_CONF" attach -t "$SESSION_NAME"
else
    echo "Session '$SESSION_NAME' doesn't exist, creating" >> "$LOG"

    # Create new session with menu
    exec tmux -f "$NESTED_CONF" new-session -s "$SESSION_NAME" bash -c "$MENU_CMD"
fi
