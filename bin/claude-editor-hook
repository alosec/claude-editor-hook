#!/usr/bin/env bash

# Debug logging
LOG="/tmp/claude-editor-hook.log"
echo "=== $(date) ===" >> "$LOG"
echo "Args: $@" >> "$LOG"
echo "TMUX: $TMUX" >> "$LOG"

# Store the file path
FILE="$1"

# Read pattern from config file (project-level or global)
PATTERN="${EDITOR_HOOK_PATTERN:-1}"  # Default to 1, or env var if set

# Check for project-level config first (takes precedence)
if [ -f ".claude-editor-hook.conf" ]; then
    source ".claude-editor-hook.conf"
    echo "Loaded config from: .claude-editor-hook.conf" >> "$LOG"
# Then check for global config
elif [ -f "$HOME/.claude-editor-hook.conf" ]; then
    source "$HOME/.claude-editor-hook.conf"
    echo "Loaded config from: ~/.claude-editor-hook.conf" >> "$LOG"
else
    echo "No config file found, using default or env var" >> "$LOG"
fi

echo "Using pattern: $PATTERN" >> "$LOG"

# Unset TMUX to allow nested sessions
unset TMUX

case "$PATTERN" in
    1)
        # Pattern 1: Simple emacs exec (like working nano pattern)
        echo "Pattern 1: Simple emacs exec" >> "$LOG"
        exec tmux new-session emacs -nw "$FILE"
        ;;

    2)
        # Pattern 2: display-popup + fzf (Interactive Picker) with session persistence
        echo "Pattern 2: fzf popup menu with persistent session" >> "$LOG"

        # Get the directory where this script lives (for finding lib/nested-tmux.conf)
        # Follow symlinks to get the actual script location
        SCRIPT_SOURCE="${BASH_SOURCE[0]:-$0}"
        while [ -L "$SCRIPT_SOURCE" ]; do
            SCRIPT_DIR="$(cd -P "$(dirname "$SCRIPT_SOURCE")" && pwd)"
            SCRIPT_SOURCE="$(readlink "$SCRIPT_SOURCE")"
            [[ $SCRIPT_SOURCE != /* ]] && SCRIPT_SOURCE="$SCRIPT_DIR/$SCRIPT_SOURCE"
        done
        SCRIPT_DIR="$(cd -P "$(dirname "$SCRIPT_SOURCE")" && pwd)"
        NESTED_CONF="$SCRIPT_DIR/../lib/nested-tmux.conf"

        # Session name - always use "Claude" for simplicity
        SESSION_NAME="Claude"

        # Menu command (reused for both new session and respawn)
        # Must source menu-core.sh inside the bash -c context
        MENU_CMD="source '$SCRIPT_DIR/../lib/menu-core.sh' && show_menu '$FILE'"

        # Check if session exists
        if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
            echo "Session '$SESSION_NAME' exists, reattaching" >> "$LOG"

            # Update PROMPT environment variable for the session
            tmux set-environment -t "$SESSION_NAME" PROMPT "$FILE"

            # Respawn window 1 with fresh menu (preserves other windows)
            # Use select-window first to ensure window 1 exists, create if not
            tmux select-window -t "$SESSION_NAME:1" 2>/dev/null || tmux new-window -t "$SESSION_NAME:1"
            tmux respawn-window -t "$SESSION_NAME:1" -k bash -c "$MENU_CMD"

            # Attach to the session
            exec tmux -f "$NESTED_CONF" attach -t "$SESSION_NAME"
        else
            echo "Session '$SESSION_NAME' doesn't exist, creating" >> "$LOG"

            # Create new session with menu
            exec tmux -f "$NESTED_CONF" new-session -s "$SESSION_NAME" bash -c "$MENU_CMD"
        fi
        ;;

    3)
        # Pattern 3: Persistent Popup Session (Dismissable)
        echo "Pattern 3: Persistent popup session" >> "$LOG"
        SESSION="_editor_popup_$$"

        # Create persistent session if it doesn't exist
        if ! tmux has-session -t "$SESSION" 2>/dev/null; then
            tmux new-session -d -s "$SESSION" emacs -nw "$FILE"
            # Use -t flag to set option only for this session (not global)
            tmux set-option -t "$SESSION" status off
        fi

        # Attach in popup mode
        exec tmux attach -t "$SESSION"
        ;;

    4)
        # Pattern 4: Simple Default + Tmux Keybinding Menu
        echo "Pattern 4: Default + tmux keybinding menu" >> "$LOG"

        # Create temp tmux conf with menu binding
        TMUX_CONF=$(mktemp)
        cat > "$TMUX_CONF" <<EOF
# Source user's main tmux config first (for basic settings)
source-file ~/.tmux.conf

# Prefix is backtick (`) - doesn't conflict with text navigation
# Use set-option (not -g) for session-local changes
set-option prefix `
unbind-key C-b
bind-key ` send-prefix

# Bind Ctrl-A m to show menu
bind-key m display-menu -T "Switch Tool" -x C -y C \
    "Emacs" e "respawn-pane -k 'emacs -nw \"$FILE\"'" \
    "Vi" v "respawn-pane -k 'vi \"$FILE\"'" \
    "Nano" n "respawn-pane -k 'nano \"$FILE\"'" \
    "Batcat" b "respawn-pane -k 'batcat \"$FILE\"'"
EOF

        exec tmux -f "$TMUX_CONF" new-session emacs -nw "$FILE"
        ;;

    5)
        # Pattern 5: Split Pane Layout with Menu
        echo "Pattern 5: Split pane with menu" >> "$LOG"

        exec tmux new-session bash -c "
            # Show menu
            echo '━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━'
            echo 'Commands: (e)macs | (v)i | (n)ano | (b)atcat'
            echo '━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━'
            echo 'Press key to launch editor...'
            echo ''

            # Wait for keypress
            read -n1 choice

            # Launch editor
            case \$choice in
                e) exec emacs -nw '$FILE' ;;
                v) exec vi '$FILE' ;;
                n) exec nano '$FILE' ;;
                b) exec batcat '$FILE' ;;
                *) exec emacs -nw '$FILE' ;;
            esac
        "
        ;;

    6)
        # Pattern 6: Pre-launch Selection (External Menu)
        echo "Pattern 6: Pre-launch bash select menu" >> "$LOG"

        # Show menu using simple bash select
        PS3="Choose editor: "
        options=("Emacs" "Vi" "Nano" "Batcat")

        select opt in "${options[@]}"; do
            case $opt in
                "Emacs") EDITOR_CMD="emacs -nw \"$FILE\""; break ;;
                "Vi") EDITOR_CMD="vi \"$FILE\""; break ;;
                "Nano") EDITOR_CMD="nano \"$FILE\""; break ;;
                "Batcat") EDITOR_CMD="batcat \"$FILE\""; break ;;
                *) echo "Invalid option"; continue ;;
            esac
        done

        exec tmux new-session bash -c "$EDITOR_CMD"
        ;;

    7)
        # Pattern 7: run-shell with Command Execution
        echo "Pattern 7: run-shell with command execution" >> "$LOG"

        # Create wrapper scripts for each command
        TMPDIR=$(mktemp -d)

        cat > "$TMPDIR/editor-emacs.sh" <<EOF
#!/bin/bash
exec emacs -nw "$FILE"
EOF
        chmod +x "$TMPDIR/editor-emacs.sh"

        cat > "$TMPDIR/editor-vi.sh" <<EOF
#!/bin/bash
exec vi "$FILE"
EOF
        chmod +x "$TMPDIR/editor-vi.sh"

        cat > "$TMPDIR/editor-nano.sh" <<EOF
#!/bin/bash
exec nano "$FILE"
EOF
        chmod +x "$TMPDIR/editor-nano.sh"

        cat > "$TMPDIR/editor-batcat.sh" <<EOF
#!/bin/bash
exec batcat "$FILE"
EOF
        chmod +x "$TMPDIR/editor-batcat.sh"

        # Launch tmux with menu that uses run-shell
        exec tmux new-session bash -c "
            tmux display-menu -T 'Choose Editor' -x C -y C \
                'Emacs' e 'run-shell $TMPDIR/editor-emacs.sh' \
                'Vi' v 'run-shell $TMPDIR/editor-vi.sh' \
                'Nano' n 'run-shell $TMPDIR/editor-nano.sh' \
                'Batcat' b 'run-shell $TMPDIR/editor-batcat.sh'

            # Cleanup temp dir
            rm -rf '$TMPDIR'
        "
        ;;

    8)
        # Pattern 8: Hybrid - Menu then Respawn
        echo "Pattern 8: Hybrid menu then respawn" >> "$LOG"

        # Create temp config
        CONF=$(mktemp)
        cat > "$CONF" <<EOF
bind-key e respawn-pane -k "emacs -nw '$FILE'"
bind-key v respawn-pane -k "vi '$FILE'"
bind-key n respawn-pane -k "nano '$FILE'"
bind-key b respawn-pane -k "batcat '$FILE'"
EOF

        exec tmux -f "$CONF" new-session bash -c "
            tmux display-menu -T 'Choose Editor' -x C -y C \
                'Emacs' e 'send-keys e' \
                'Vi' v 'send-keys v' \
                'Nano' n 'send-keys n' \
                'Batcat' b 'send-keys b'

            # Hold session open
            sleep infinity
        "
        ;;

    9)
        # Pattern 9: DEPRECATED - Old standalone enhancement pattern
        # NOTE: This pattern is deprecated. Use Pattern 2 (FZF menu) instead.
        # Pattern 2 provides "Enhance (Non-interactive)" which uses the new
        # directive system (#enhance, #spellcheck, #suggest, etc.)
        echo "Pattern 9: DEPRECATED - Use Pattern 2 instead" >> "$LOG"

        # Don't open editor - return directly to Claude Code
        ;;

    *)
        # Default to Pattern 1 if invalid pattern specified
        echo "Invalid pattern '$PATTERN', defaulting to Pattern 1" >> "$LOG"
        exec tmux new-session emacs -nw "$FILE"
        ;;
esac
